// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  BU_MANAGER
  BU
  COMPANY
}

enum InvoiceType {
  REGULAR
  CARRY
}

enum InvoiceStatus {
  DRAFT
  SUBMITTED
  PENDING_BU_MANAGER_APPROVAL
  PENDING_CARRY_COMPANY_APPROVAL
  APPROVED
  REJECTED
}

enum ApprovalDecision {
  APPROVED
  REJECTED
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  role      Role
  companyId String?  // Only for users with role = COMPANY
  createdAt DateTime @default(now())

  // Relations
  company          Company?            @relation("CompanyUsers", fields: [companyId], references: [id])
  managedGroups    CompanyGroup[]      @relation("GroupManager")
  assignedGroups   BUGroupAssignment[] @relation("BUAssignments")
  createdInvoices  Invoice[]           @relation("InvoiceCreator")
  approvals        InvoiceApproval[]   @relation("Approver")
}

model CompanyGroup {
  id        String   @id @default(uuid())
  name      String
  managerId String

  manager     User                @relation("GroupManager", fields: [managerId], references: [id])
  companies   Company[]
  assignments BUGroupAssignment[]

  @@unique([name, managerId])
}

model Company {
  id      String @id @default(uuid())
  name    String
  groupId String

  group            CompanyGroup        @relation(fields: [groupId], references: [id])
  originalInvoices Invoice[]           @relation("OriginalCompany")
  carryInvoices    Invoice[]           @relation("CarryCompany")
  users            User[]              @relation("CompanyUsers") // COMPANY role users belonging to this company

  @@unique([name, groupId])
}

model BUGroupAssignment {
  id      String @id @default(uuid())
  buId    String
  groupId String

  bu    User         @relation("BUAssignments", fields: [buId], references: [id])
  group CompanyGroup @relation(fields: [groupId], references: [id])

  @@unique([buId, groupId])
}

model Invoice {
  id                String        @id @default(uuid())
  type              InvoiceType
  status            InvoiceStatus @default(DRAFT)
  originalCompanyId String
  carryCompanyId    String?       // Null for REGULAR invoices
  buId              String
  createdAt         DateTime      @default(now())

  // Relations
  originalCompany Company       @relation("OriginalCompany", fields: [originalCompanyId], references: [id])
  carryCompany    Company?      @relation("CarryCompany", fields: [carryCompanyId], references: [id])
  creator         User          @relation("InvoiceCreator", fields: [buId], references: [id])
  approvals       InvoiceApproval[]

  // Indexes for better query performance
  @@index([buId])
  @@index([originalCompanyId])
  @@index([carryCompanyId])
  @@index([status])
}

model InvoiceApproval {
  id         String           @id @default(uuid())
  invoiceId  String
  approverId String
  role       Role
  decision   ApprovalDecision
  remarks    String           @default("")
  createdAt  DateTime         @default(now())

  invoice    Invoice          @relation(fields: [invoiceId], references: [id])
  approver   User             @relation("Approver", fields: [approverId], references: [id])

  @@unique([invoiceId, approverId])
}